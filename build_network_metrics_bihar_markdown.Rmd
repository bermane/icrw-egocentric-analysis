---
title: "Bihar Network Metrics"
author: "Ethan Berman"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Ego Metrics

```{r, echo = F, warning = F, message = F, results = 'asis'}
# this code loads network objects for ego and alter and generates network metrics
# and related figures

# load packages
library(tidyverse)
library(igraph)
library(ggraph)
library(janitor)
library(magrittr)
library(kableExtra)

#######################################
### EGO NETWORK DATA BASIC METRICS ####
#######################################

# load ego igraph objects
load("/Users/bermane/Team Braintree Dropbox/Ethan Berman/R Projects/icrw-egocentric-analysis/data/ego_igraph.rda")

# measures based on ego
ego_ego_met <- gr_list_ego %>%
  map_dfr(~ tibble(deg = degree(.x, v = 'ego'),
                   bet = betweenness(.x, v = 'ego', weights = NA),
                   clo = closeness(.x, v = 'ego', weights = NA)),
          .id = 'ego_id')

# print ego degree centrality table
ego_ego_met %>% tabyl(deg) %>% round(2) %>%
  rename(degree = deg) %>%
  kbl(caption = 'Ego Degree Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# print ego betweeness centrality table
ego_ego_met %>% tabyl(bet) %>% round(2) %>%
  rename(betweenness = bet) %>%
  kbl(caption = 'Ego Betweenness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# print ego closeness table
ego_ego_met %>% tabyl(clo) %>% round(2) %>%
  rename(closeness = clo) %>%
  kbl(caption = 'Ego Closeness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# sort ego_df and ego_ego_met by ego_id
ego_ego_met %<>% arrange(ego_id)
ego_df %<>% arrange(ego_id)

# make sure ego_ids match
# sum(ego_ego_met$ego_id == ego_df$ego_id)
  
# add district, block, age, education, caste, parity, husband migrant columns to ego_ego_met
ego_ego_met %<>% add_column(district = ego_df$district_name,
                            block = ego_df$block_name,
                            age = ego_df$ego_age,
                            edu = ego_df$ego_edu,
                            caste = ego_df$ego_caste,
                            parity = ego_df$ego_parity,
                            husband_migrant = ego_df$ego_hus_mig,
                            ever_worked = ego_df$ego_ever_worked,
                            worked_last_year = ego_df$ego_worked_lastyr)

# calculate degree centrality by ego age
# two groups, 18-21 and 22-24
ego_ego_met %>%
  select(deg, age) %>%
  rename(degree = deg) %>%
  mutate(age = case_when(age <= 21 ~ '18-21',
                         age > 21 ~ '22-24')) %>%
  tabyl(age, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = 'Ego Degree Centrality by Age') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# calculate degree centrality by ego parity
# NA, 0, 1, 2
ego_ego_met %>%
  select(deg, parity) %>%
  rename(degree = deg) %>%
  tabyl(parity, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = 'Ego Degree Centrality by Parity') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# calculate degree centrality by ego education
# 0, 1-8, 9+
ego_ego_met %>%
  select(deg, edu) %>%
  rename(education = edu, degree = deg) %>%
  mutate(education = case_when(education == 0 ~ 'None',
                         education > 0 & education <= 8 ~ '1-8',
                         education > 8 ~ '9+')) %>%
  mutate(education = ordered(education, levels = c('None', '1-8', '9+'))) %>%
  tabyl(education, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = 'Ego Degree Centrality by Education') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# calculate degree centrality by ego caste
# 0, 1-8, 9+
ego_ego_met %>%
  select(deg, caste) %>%
  rename(degree = deg) %>%
  mutate(caste = case_when(caste == 1 ~ 'Scheduled Caste',
                           caste == 2 ~ 'Scheduled Tribe',
                           caste == 3 ~ 'Other Backward Class',
                           caste == 4 ~ 'None of Them')) %>%
  mutate(caste = ordered(caste, levels = c('Scheduled Caste', 'Scheduled Tribe', 
                                       'Other Backward Class', 'None of Them'))) %>%
  tabyl(caste, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = 'Ego Degree Centrality by Caste') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# calculate degree centrality by ego employment
# worked ever, 1 = yes, 2 = no
ego_ego_met %>%
  select(deg, ever_worked) %>%
  rename(degree = deg) %>%
  tabyl(ever_worked, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = 'Ego Degree Centrality by Whether Ego has Ever Worked') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# worked in the last year, 1-3 = yes, 2 or NA = no
ego_ego_met %>%
  select(deg, worked_last_year) %>%
  rename(degree = deg) %>%
  mutate(worked_last_year = case_when(worked_last_year >= 1 & worked_last_year <= 3 ~ 'Yes',
                                      worked_last_year == 4 | is.na(worked_last_year)  ~ 'No')) %>%
  tabyl(worked_last_year, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = 'Ego Degree Centrality by Whether Ego has Worked in the Last Year') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# calculate degree centrality by ego's husband migrant
# yes = 3-7, no = 1-2
ego_ego_met %>%
  select(deg, husband_migrant) %>%
  rename(degree = deg) %>%
  mutate(husband_migrant = case_when(husband_migrant < 3 ~ 'No',
                                     husband_migrant >= 3 & husband_migrant <= 7 ~ 'Yes')) %>%
  tabyl(husband_migrant, degree) %>%
  adorn_percentages("row") %>%
  adorn_pct_formatting(digits = 2) %>%
  adorn_ns() %>% 
  adorn_title(placement = 'top') %>%
  kbl(caption = "Ego Degree Centrality by Whether Ego's Husband is Migrant") %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# ego table by block
ego_ego_met %>% 
            group_by(block) %>% 
            summarize(degree = mean(deg, na.rm = T) %>% round(2),
                      betweenness = mean(bet, na.rm = T) %>% round(2),
                      closeness = mean(clo, na.rm = T) %>% round(2)) %>%
            mutate(n = ego_ego_met %>% group_by(block) %>% tally() %>% .$n) %>%
  kbl(caption = 'Ego Mean Degree, Betweenness and Closeness Centrality by Block') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# write ego table by district
ego_ego_met %>% 
            group_by(district) %>% 
            summarize(degree = mean(deg, na.rm = T) %>% round(2),
                      betweenness = mean(bet, na.rm = T) %>% round(2),
                      closeness = mean(clo, na.rm = T) %>% round(2)) %>%
            mutate(n = ego_ego_met %>% group_by(district) %>% tally() %>% .$n) %>%
  kbl(caption = 'Ego Mean Degree, Betweenness and Closeness Centrality by District') %>%
  kable_classic_2('hover', full_width = F, position = 'left')
```
# Alters in Ego's Network

```{r, echo = F, warning = F, message = F, results = 'asis'}
# measures based on alter
# alter degree centrality
# alter betweenness centrality
ego_alt_met <- gr_list %>%
  map_dfr(~ tibble(mean_deg = mean(degree(.x)),
                   mean_bet = mean(betweenness(.x, weights = NA)),
                   deg_centr = centr_degree(.x)$centralization,
                   mean_clo = mean(closeness(.x, weights = NA)),
                   dens = edge_density(.x)),
          .id = 'ego_id')

# alter mean degree table
ego_alt_met %>% tabyl(mean_deg) %>% round(2) %>%
  rename(mean_degree = mean_deg) %>%
  kbl(caption = 'Alter Mean Degree Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter mean betweeness table
ego_alt_met %>% tabyl(mean_bet) %>% round(2) %>%
  rename(mean_betweenness = mean_bet) %>%
  kbl(caption = 'Alter Mean Betweenness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter mean closeness table
ego_alt_met %>% tabyl(mean_clo) %>% round(2) %>%
  rename(mean_closeness = mean_clo) %>%
  kbl(caption = 'Alter Mean Closeness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# write alter density table
ego_alt_met %>% tabyl(dens) %>% round(2) %>%
  rename(density = dens) %>%
  kbl(caption = 'Alter Density') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# sort ego_df and ego_alt_met by ego_id
ego_alt_met %<>% arrange(ego_id)
ego_df %<>% arrange(ego_id)

# make sure ego_ids match
# sum(ego_alt_met$ego_id == ego_df$ego_id)

# add district and block columns to ego_alt_met
ego_alt_met %<>% add_column(district = ego_df$district_name,
                            block = ego_df$block_name)

# write ego_alt table by block
ego_alt_met %>% 
            group_by(block) %>% 
            summarize(mean_degree = mean(mean_deg, na.rm = T) %>% round(2),
                      mean_betweenness = mean(mean_bet, na.rm = T) %>% round(2),
                      mean_closeness = mean(mean_clo, na.rm = T) %>% round(2),
                      mean_density = mean(dens, na.rm = T) %>% round(2)) %>%
            mutate(n = ego_alt_met %>% group_by(block) %>% tally() %>% .$n) %>%
  kbl(caption = 'Alter Mean Degree, Betweenness, Closeness Centrality, and Density by Block') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# write ego_alt table by district
ego_alt_met %>% 
            group_by(district) %>% 
            summarize(mean_degree = mean(mean_deg, na.rm = T) %>% round(2),
                      mean_betweenness = mean(mean_bet, na.rm = T) %>% round(2),
                      mean_closeness = mean(mean_clo, na.rm = T) %>% round(2),
                      mean_density = mean(dens, na.rm = T) %>% round(2)) %>%
            mutate(n = ego_alt_met %>% group_by(district) %>% tally() %>% .$n) %>%
  kbl(caption = 'Alter Mean Degree, Betweenness, Closeness Centrality, and Density by District') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

```

# Alter Metrics (Alter Survey where Alter is effectively the "ego")

```{r, echo = F, warning = F, message = F, results = 'asis'}
########################################
### ALTER NETWORK DATA BASIC METRICS ###
########################################

# load alter igraph objects
load("/Users/bermane/Team Braintree Dropbox/Ethan Berman/R Projects/icrw-egocentric-analysis/data/alter_igraph.rda")

# create table of unique blocks showing district as well
# write.csv(alter_df %>% select(district_name, block_name) %>% distinct(block_name, .keep_all = T), 
#          file = 'results/alter_district_block.csv', row.names = F)

# measures based on alter
# alter degree centrality
alt_alt_met <- gr_list_a_alt %>%
  map_dfr(~ tibble(deg = degree(.x, v = 'ego'),
                   bet = betweenness(.x, v = 'ego', weights = NA),
                   clo = closeness(.x, v = 'ego', weights = NA)),
          .id = 'alter_id')

# alter degree centrality table
alt_alt_met %>% tabyl(deg) %>% round(2) %>%
  rename(degree = deg) %>%
  kbl(caption = 'Alter Degree Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter betweeness centrality table
alt_alt_met %>% tabyl(bet) %>% round(2) %>%
  rename(betweenness = bet) %>%
  kbl(caption = 'Alter Betweenness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter closeness table
alt_alt_met %>% tabyl(clo) %>% round(2) %>%
  rename(closeness = clo) %>%
  kbl(caption = 'Alter Closeness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# sort alter_df and alt_alt_met by ego_id
alt_alt_met %<>% arrange(alter_id)
alter_df %<>% arrange(alter_id)

# make sure alter_ids match
# sum(alt_alt_met$alter_id == alter_df$alter_id)

# add district, block, age, education, caste columns to alt_alt_met
alt_alt_met %<>% add_column(district = alter_df$district_name,
                            block = alter_df$block_name,
                            age = alter_df$age,
                            edu = alter_df$education,
                            caste = alter_df$caste)

# write alt_alt table by block
alt_alt_met %>% 
            group_by(block) %>% 
            summarize(degree = mean(deg, na.rm = T) %>% round(2),
                      betweenness = mean(bet, na.rm = T) %>% round(2),
                      closeness = mean(clo, na.rm = T) %>% round(2)) %>%
            mutate(n = alt_alt_met %>% group_by(block) %>% tally() %>% .$n) %>%
  kbl(caption = 'Alter Mean Degree, Betweenness and Closeness Centrality by Block') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# write alt_alt table by district
alt_alt_met %>% 
            group_by(district) %>% 
            summarize(degree = mean(deg, na.rm = T) %>% round(2),
                      betweenness = mean(bet, na.rm = T) %>% round(2),
                      closeness = mean(clo, na.rm = T) %>% round(2)) %>%
            mutate(n = alt_alt_met %>% group_by(district) %>% tally() %>% .$n) %>%
  kbl(caption = 'Alter Mean Degree, Betweenness and Closeness Centrality by District') %>%
  kable_classic_2('hover', full_width = F, position = 'left')
```

# Alter's Alters in Alter's Network

```{r, echo = F, warning = F, message = F, results = 'asis'}
# measures based on aalter
# aalter degree centrality
# aalter betweenness centrality
alt_aalt_met <- gr_list_a %>%
  map_dfr(~ tibble(mean_deg = mean(degree(.x)),
                   mean_bet = mean(betweenness(.x, weights = NA)),
                   deg_centr = centr_degree(.x)$centralization,
                   mean_clo = mean(closeness(.x, weights = NA)),
                   dens = edge_density(.x)),
          .id = 'alter_id')

# alter mean degree table
alt_aalt_met %>% tabyl(mean_deg) %>% round(2) %>% 
  rename(mean_degree = mean_deg) %>%
  kbl(caption = 'AAlter Mean Degree Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter mean betweeness table
alt_aalt_met %>% tabyl(mean_bet) %>% round(2) %>%
  rename(mean_betweenness = mean_bet) %>%
  kbl(caption = 'AAlter Mean Betweenness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter mean closeness table
alt_aalt_met %>% tabyl(mean_clo) %>% round(2) %>%
  rename(mean_closeness = mean_clo) %>%
  kbl(caption = 'AAlter Mean Closeness Centrality') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# alter density table
alt_aalt_met %>% tabyl(dens) %>% round(2) %>%
  rename(density = dens) %>%
  kbl(caption = 'AAlter Density') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# sort alter_df and alt_aalt_met by ego_id
alt_aalt_met %<>% arrange(alter_id)
alter_df %<>% arrange(alter_id)

# make sure alter_ids match
# sum(alt_aalt_met$alter_id == alter_df$alter_id)

# add district and block columns to alt_aalt_met
alt_aalt_met %<>% add_column(district = alter_df$district_name,
                            block = alter_df$block_name)

# write alt_aalt table by block
alt_aalt_met %>% 
            group_by(block) %>% 
            summarize(mean_degree = mean(mean_deg, na.rm = T) %>% round(2),
                      mean_betweenness = mean(mean_bet, na.rm = T) %>% round(2),
                      mean_closeness = mean(mean_clo, na.rm = T) %>% round(2),
                      mean_density = mean(dens, na.rm = T) %>% round(2)) %>%
            mutate(n = alt_aalt_met %>% group_by(block) %>% tally() %>% .$n) %>%
  kbl(caption = 'AAlter Mean Degree, Betweenness, Closeness Centrality, and Density by Block') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

# write alt_aalt table by district
alt_aalt_met %>% 
            group_by(district) %>% 
            summarize(mean_degree = mean(mean_deg, na.rm = T) %>% round(2),
                      mean_betweenness = mean(mean_bet, na.rm = T) %>% round(2),
                      mean_closeness = mean(mean_clo, na.rm = T) %>% round(2),
                      mean_density = mean(dens, na.rm = T) %>% round(2)) %>%
            mutate(n = alt_aalt_met %>% group_by(district) %>% tally() %>% .$n) %>%
  kbl(caption = 'AAlter Mean Degree, Betweenness, Closeness Centrality, and Density by Block') %>%
  kable_classic_2('hover', full_width = F, position = 'left')

```
# Figures

```{r, echo = F, warning = F, message = F, results = 'asis'}

############################################
### FIGURES OF DEGREE CENTRALITY OVERALL ###
############################################

# degree centrality of ego and alter
# first add ego
deg <- tibble(id = ego_ego_met$ego_id,
              deg = ego_ego_met$deg,
              district = ego_ego_met$district,
              age = ego_ego_met$age,
              edu = ego_ego_met$edu,
              caste = ego_ego_met$caste,
              group = 'ego') 

# second add alter
deg <- rbind(deg, tibble(id = alt_alt_met$alter_id,
                         deg = alt_alt_met$deg,
                         district = alt_alt_met$district,
                         age = alt_alt_met$age,
                         edu = alt_alt_met$edu,
                         caste = alt_alt_met$caste,
                         group = 'alter')) 

# change ego, edu, caste to numeric
deg %<>% mutate(age = as.numeric(age) %>% factor,
                edu = as.numeric(edu) %>% factor,
                caste = as.numeric(caste) %>% factor)

# reshape df
deg_sum <- deg %>% group_by(group) %>% count(deg)

# add missing val for ego
deg_sum <- rbind(deg_sum, tibble(group = 'ego',
                                 deg = 1,
                                 n = 0))

# generate colorscale
# colscale_egoalt <- scale_fill_manual(name = "Group", values = c('ego' = '#CCBB44', 'alter' = '#EE6677',
#                                                                 'Overall' = '#4477AA'))
colscale_egoalt <- scale_fill_manual(name = "Group", values = c('ego' = '#CCBB44', 'alter' = '#EE6677'),
                                     labels = c('ego' = 'Ego', 'alter' = 'Alter'))

# # plot degree by n
# ggplot(deg_sum, aes(x = deg %>% as.factor, y = n, fill = ordered(group, levels = c('ego', 'alter')))) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   labs(x = 'Degree', y = 'N', fill = 'Group') +
#   colscale_egoalt +  xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Ego and Alter') +
#   theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_ego_alt_plot_n.png')

# plot degree by perc
deg_sum$perc <- NA
deg_sum$perc[deg_sum$group == 'alter'] <- deg_sum$n[deg_sum$group == 'alter']/sum(deg_sum$n[deg_sum$group == 'alter'])
deg_sum$perc[deg_sum$group == 'ego'] <- deg_sum$n[deg_sum$group == 'ego']/sum(deg_sum$n[deg_sum$group == 'ego'])
deg_sum$perc <- round(deg_sum$perc, 2)

ggplot(deg_sum, aes(x = deg %>% as.factor, y = perc*100, fill = ordered(group, levels = c('ego', 'alter')))) +
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  labs(x = 'Degree', y = 'Percent by Group', fill = 'Group') +
  colscale_egoalt +  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Ego and Alter') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_ego_alt_plot_perc.png')

########################################
### FIGURES OF DEG CENTRALITY BY AGE ###
########################################

# segment df by ego age
deg_ego_age <- deg %>% 
  filter(group == 'ego') %>% 
  group_by(age) %>% 
  count(deg)

# add in missing values
for(i in unique(deg_ego_age$age)){
  for(j in 0:5){
    check <- deg_ego_age %>%
      filter(age == i,
             deg == j)
    if(NROW(check) == 0){
      deg_ego_age %<>% rbind(tibble(age = i,
                                    deg = j,
                                    n = 0))
    }
  }
}

# generate colorscale
colscale_egoage <- scale_fill_manual(name = "Age", values = c('18' = '#4477AA', '19' = '#66CCEE',
                                                              '20' = '#228833', '21' = '#CCBB44',
                                                              '22' = '#EE6677', '23' = '#AA3377',
                                                              '24' = '#BBBBBB'))

# # plot degree by ego age
# ggplot(deg_ego_age, aes(x = deg %>% as.factor, y = n, fill = age)) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   colscale_egoage +
#   labs(x = 'Degree', y = 'N', fill = 'Age') +  
#   xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Ego by Age') +
#   theme(text = element_text(size=20))
# 
# ggsave('results/figures/deg_cent_ego_age_plot_n.png')

# plot degree by perc
deg_ego_age$perc <- NA
for(i in unique(deg_ego_age$age)){
  deg_ego_age$perc[deg_ego_age$age == i] <- deg_ego_age$n[deg_ego_age$age == i]/sum(deg_ego_age$n[deg_ego_age$age == i])
}
deg_ego_age$perc <- round(deg_ego_age$perc, 2)

ggplot(deg_ego_age, aes(x = deg %>% as.factor, y = perc*100, fill = age)) +
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  colscale_egoage + 
  labs(x = 'Degree', y = 'Percent by Age Group', fill = 'Age') +  
  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Ego by Age') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_ego_age_plot_perc.png')

# segment df by alter age
deg_alt_age <- deg %>% 
  filter(group == 'alter')

# factor age groups
deg_alt_age %<>% mutate(age = age %>%
                          as.character %>%
                          as.numeric %>%
                          cut(c(17,19,29,39,49,59,101),
                              labels = c('18-19', '20-29', '30-39', '40-49', '50-59','60+'))) %>%
  group_by(age) %>% 
  count(deg)

# add in missing values
for(i in unique(deg_alt_age$age)){
  for(j in 0:5){
    check <- deg_alt_age %>%
      filter(age == i,
             deg == j)
    if(NROW(check) == 0){
      deg_alt_age %<>% rbind(tibble(age = i,
                                    deg = j,
                                    n = 0))
    }
  }
}

# generate colorscale
colscale_altage <- scale_fill_manual(name = "Age", values = c('18-19' = '#4477AA', '20-29' = '#66CCEE',
                                                              '30-39' = '#228833', '40-49' = '#CCBB44',
                                                              '50-59' = '#EE6677', '60+' = '#AA3377'))

# # plot degree by alter age
# ggplot(deg_alt_age, aes(x = deg %>% as.factor, y = n, fill = age)) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   colscale_altage +
#   labs(x = 'Degree', y = 'N', fill = 'Age') +  
#   xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Alter by Age') +
#   theme(text = element_text(size=20))
# 
# ggsave('results/figures/deg_cent_alt_age_plot_n.png')

# plot degree by perc
deg_alt_age$perc <- NA
for(i in unique(deg_alt_age$age)){
  deg_alt_age$perc[deg_alt_age$age == i] <- deg_alt_age$n[deg_alt_age$age == i]/sum(deg_alt_age$n[deg_alt_age$age == i])
}
deg_alt_age$perc <- round(deg_alt_age$perc, 2)

ggplot(deg_alt_age, aes(x = deg %>% as.factor, y = perc*100, fill = age)) +
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  colscale_altage + 
  labs(x = 'Degree', y = 'Percent by Age Group', fill = 'Age') +  
  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Alter by Age') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_alt_age_plot_perc.png')

##########################################
### FIGURES OF DEG CENTRALITY BY CASTE ###
##########################################

# segment df by ego caste
deg_ego_caste <- deg %>% 
  filter(group == 'ego')

# factor caste groups
deg_ego_caste %<>% mutate(caste = caste %>%
                          as.character %>%
                          as.numeric %>%
                          cut(c(0,2,3,4),
                              labels = c('Schedule Caste/Tribe', 'Other Backward Class', 'Other'))) %>%
  group_by(caste) %>% 
  count(deg)

# add in missing values
for(i in unique(deg_ego_caste$caste)){
  for(j in 0:5){
    check <- deg_ego_caste %>%
      filter(caste == i,
             deg == j)
    if(NROW(check) == 0){
      deg_ego_caste %<>% rbind(tibble(caste = i,
                                    deg = j,
                                    n = 0))
    }
  }
}

# generate colorscale
colscale_caste <- scale_fill_manual(name = "Caste", values = c('Schedule Caste/Tribe' = '#4477AA',
                                                              'Other Backward Class' = '#228833', 
                                                              'Other' = '#EE6677'))

# # plot degree by ego caste
# ggplot(deg_ego_caste, aes(x = deg %>% as.factor, 
#                           y = n, 
#                           fill = ordered(caste,
#                                          levels = c('Schedule Caste/Tribe',
#                                                     'Other Backward Class',
#                                                     'Other')))) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   colscale_caste +
#   labs(x = 'Degree', y = 'N', fill = 'Caste') +  
#   xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Ego by Caste') +
#   theme(text = element_text(size=20))
# 
# ggsave('results/figures/deg_cent_ego_caste_plot_n.png')

# plot degree by perc
deg_ego_caste$perc <- NA
for(i in unique(deg_ego_caste$caste)){
  deg_ego_caste$perc[deg_ego_caste$caste == i] <- deg_ego_caste$n[deg_ego_caste$caste == i]/sum(deg_ego_caste$n[deg_ego_caste$caste == i])
}
deg_ego_caste$perc <- round(deg_ego_caste$perc, 2)

ggplot(deg_ego_caste, aes(x = deg %>% as.factor,
                          y = perc*100, 
                          fill = ordered(caste, 
                                         levels = c('Schedule Caste/Tribe', 
                                                   'Other Backward Class', 
                                                   'Other')))) +                                 
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  colscale_caste + 
  labs(x = 'Degree', y = 'Percent by Caste Group', fill = 'Caste') +  
  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Ego by Caste') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_ego_caste_plot_perc.png')

# segment df by alter caste
deg_alt_caste <- deg %>% 
  filter(group == 'alter')

# factor caste groups
deg_alt_caste %<>% mutate(caste = caste %>%
                            as.character %>%
                            as.numeric %>%
                            cut(c(0,2,3,4),
                                labels = c('Schedule Caste/Tribe', 'Other Backward Class', 'Other'))) %>%
  group_by(caste) %>% 
  count(deg)

# add in missing values
for(i in unique(deg_alt_caste$caste)){
  for(j in 0:5){
    check <- deg_alt_caste %>%
      filter(caste == i,
             deg == j)
    if(NROW(check) == 0){
      deg_alt_caste %<>% rbind(tibble(caste = i,
                                      deg = j,
                                      n = 0))
    }
  }
}

# # plot degree by alter caste
# ggplot(deg_alt_caste, aes(x = deg %>% as.factor, 
#                           y = n, 
#                           fill = ordered(caste,
#                                          levels = c('Schedule Caste/Tribe',
#                                                     'Other Backward Class',
#                                                     'Other')))) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   colscale_caste +
#   labs(x = 'Degree', y = 'N', fill = 'Caste') +  
#   xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Alter by Caste') +
#   theme(text = element_text(size=20))
# 
# ggsave('results/figures/deg_cent_alt_caste_plot_n.png')

# plot degree by perc
deg_alt_caste$perc <- NA
for(i in unique(deg_alt_caste$caste)){
  deg_alt_caste$perc[deg_alt_caste$caste == i] <- deg_alt_caste$n[deg_alt_caste$caste == i]/sum(deg_alt_caste$n[deg_alt_caste$caste == i])
}
deg_alt_caste$perc <- round(deg_alt_caste$perc, 2)

ggplot(deg_alt_caste, aes(x = deg %>% as.factor,
                          y = perc*100, 
                          fill = ordered(caste, 
                                         levels = c('Schedule Caste/Tribe', 
                                                    'Other Backward Class', 
                                                    'Other')))) +                                 
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  colscale_caste + 
  labs(x = 'Degree', y = 'Percent by Caste Group', fill = 'Caste') +  
  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Alter by Caste') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_alt_caste_plot_perc.png')

##############################################
### FIGURES OF DEG CENTRALITY BY EDUCATION ###
##############################################

# segment df by ego education
deg_ego_edu <- deg %>% 
  filter(group == 'ego')

# factor caste groups
deg_ego_edu %<>% mutate(edu = edu %>%
                            as.character %>%
                            as.numeric %>%
                            cut(c(-1,0,8,100),
                                labels = c('None', '1-8', '9+'))) %>%
  group_by(edu) %>% 
  count(deg)

# add in missing values
for(i in unique(deg_ego_edu$edu)){
  for(j in 0:5){
    check <- deg_ego_edu %>%
      filter(edu == i,
             deg == j)
    if(NROW(check) == 0){
      deg_ego_edu %<>% rbind(tibble(edu = i,
                                      deg = j,
                                      n = 0))
    }
  }
}

# generate colorscale
colscale_edu <- scale_fill_manual(name = "Education", values = c('None' = '#4477AA',
                                                               '1-8' = '#228833', 
                                                               '9+' = '#EE6677'))

# # plot degree by ego education
# ggplot(deg_ego_edu, aes(x = deg %>% as.factor, 
#                           y = n, 
#                           fill = ordered(edu,
#                                          levels = c('None',
#                                                     '1-8',
#                                                     '9+')))) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   colscale_edu +
#   labs(x = 'Degree', y = 'N', fill = 'Education') +  
#   xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Ego by Education') +
#   theme(text = element_text(size=20))
# 
# ggsave('results/figures/deg_cent_ego_edu_plot_n.png')

# plot degree by perc
deg_ego_edu$perc <- NA
for(i in unique(deg_ego_edu$edu)){
  deg_ego_edu$perc[deg_ego_edu$edu == i] <- deg_ego_edu$n[deg_ego_edu$edu == i]/sum(deg_ego_edu$n[deg_ego_edu$edu == i])
}
deg_ego_edu$perc <- round(deg_ego_edu$perc, 2)

ggplot(deg_ego_edu, aes(x = deg %>% as.factor,
                          y = perc*100, 
                          fill = ordered(edu,
                                          levels = c('None',
                                                     '1-8',
                                                     '9+')))) +                                 
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  colscale_edu + 
  labs(x = 'Degree', y = 'Percent by Education Group', fill = 'Education') +  
  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Ego by Education') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_ego_edu_plot_perc.png')

# segment df by alter education
deg_alt_edu <- deg %>% 
  filter(group == 'alter')

# factor caste groups
deg_alt_edu %<>% mutate(edu = edu %>%
                          as.character %>%
                          as.numeric %>%
                          cut(c(-1,0,8,100),
                              labels = c('None', '1-8', '9+'))) %>%
  group_by(edu) %>% 
  count(deg)

# add in missing values
for(i in unique(deg_alt_edu$edu)){
  for(j in 0:5){
    check <- deg_alt_edu %>%
      filter(edu == i,
             deg == j)
    if(NROW(check) == 0){
      deg_alt_edu %<>% rbind(tibble(edu = i,
                                    deg = j,
                                    n = 0))
    }
  }
}

# # plot degree by ego education
# ggplot(deg_alt_edu, aes(x = deg %>% as.factor, 
#                         y = n, 
#                         fill = ordered(edu,
#                                        levels = c('None',
#                                                   '1-8',
#                                                   '9+')))) +
#   geom_bar(stat = 'identity',
#            position = position_dodge()) +
#   theme_bw() +
#   colscale_edu +
#   labs(x = 'Degree', y = 'N', fill = 'Education') +  
#   xlim('0', '1', '2', '3', '4', '5') +
#   ggtitle('Degree Centrality of Alter by Education') +
#   theme(text = element_text(size=20))
# 
# ggsave('results/figures/deg_cent_alt_edu_plot_n.png')

# plot degree by perc
deg_alt_edu$perc <- NA
for(i in unique(deg_alt_edu$edu)){
  deg_alt_edu$perc[deg_alt_edu$edu == i] <- deg_alt_edu$n[deg_alt_edu$edu == i]/sum(deg_alt_edu$n[deg_alt_edu$edu == i])
}
deg_alt_edu$perc <- round(deg_alt_edu$perc, 2)

ggplot(deg_alt_edu, aes(x = deg %>% as.factor,
                        y = perc*100, 
                        fill = ordered(edu,
                                       levels = c('None',
                                                  '1-8',
                                                  '9+')))) +                                 
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  colscale_edu + 
  labs(x = 'Degree', y = 'Percent by Education Group', fill = 'Education') +  
  xlim('0', '1', '2', '3', '4', '5') +
  ggtitle('Degree Centrality of Alter by Education') +
  theme(text = element_text(size=20))

# ggsave('results/figures/deg_cent_alt_edu_plot_perc.png')

```

``````{r, echo = F, warning = F, message = F, results = 'asis', fig.width = 13,fig.height = 8}
##################################
### PLOTS OF NETWORK STRUCTURE ###
##################################

# density of 1st net
# ego_alt_met$dens[1]

# basic plot
ggraph(gr_list_ego[[1]], 'dh') +
  geom_edge_link(aes(linetype = as.factor(weight))) +
  geom_node_label(aes(label = name)) + 
  theme_graph(base_family = 'Helvetica') +
  scale_edge_linetype_manual(values = c('dotted', 'solid')) + 
  theme(legend.position="none") +
  ggtitle('Ego-Alter Network (Density = 1)')

# ggsave(filename = 'results/figures/ego_net_1.png')

# density of 1st net
# ego_alt_met$dens[108]

# basic plot2
ggraph(gr_list_ego[[108]], 'dh') +
  geom_edge_link(aes(linetype = as.factor(weight))) +
  geom_node_label(aes(label = name)) + 
  theme_graph(base_family = 'Helvetica') +
  scale_edge_linetype_manual(values = c('dotted', 'solid')) + 
  theme(legend.position="none") +
  ggtitle('Ego-Alter Network (Density = 0.7)')

# ggsave(filename = 'results/figures/ego_net_109.png')

# density of 1st net
# ego_alt_met$dens[80]

# basic plot2
ggraph(gr_list_ego[[80]], 'dh') +
  geom_edge_link(aes(linetype = as.factor(weight))) +
  geom_node_label(aes(label = name)) + 
  theme_graph(base_family = 'Helvetica') +
  scale_edge_linetype_manual(values = c('dotted', 'solid')) + 
  theme(legend.position="none") +
  ggtitle('Ego-Alter Network (Density = 0.6)')

# ggsave(filename = 'results/figures/ego_net_81.png')
```